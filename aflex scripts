https://www.a10networks.com/blog/aflex-examples/

provider "thunder" {
  # Provider configuration here
  # Include authentication details and target ADC IP address
}

resource "thunder_virtual_server" "vip" {
  name       = "your_vip_name"
  ip_address = "your_vip_ip_address"
  
  port_list {
    port_number  = 80
    protocol     = "http"
    service_group = "your_service_group_name"
    aflex_scripts = [<<EOF
when HTTP_REQUEST {
  if {[LB::status pool Server_HTTP] equals "down" } {
    HTTP::respond 200 content "<html><head><title>Apology
    Page</title></head><body>We are sorry for the inconvenience, but
    the site is temporarily out of service<br>If you feel you have
    reached this page in error, please try again.<p></body></html>"
  }
}
EOF
    ]
  }
}
----------
      aflex_scripts = [<<-EOT
when HTTP_REQUEST {
  if {[LB::status pool Server_HTTP] equals "down" } {
    HTTP::respond 200 content "<html><head><title>Apology
    Page</title></head><body>We are sorry for the inconvenience, but
    the site is temporarily out of service<br>If you feel you have
    reached this page in error, please try again.<p></body></html>"
  }
}
EOT
      ]
*****

sh-3.2# terraform plan
╷
│ Error: Unsupported block type
│ 
│   on main.tf line 55, in resource "thunder_slb_virtual_server" "virtual_server":
│   55: resource "thunder_file_aflex_local" "aflex_script" {
│ 
│ Blocks of type "resource" are not expected here.


0000


sh-3.2# vi main.tf

locals {
  config = yamldecode(file("${var.config_path}"))
}

# Dynamically create servers based on the config.yaml
resource "thunder_slb_server" "server" {
  for_each = {for s in local.config.servers : s.name => s}

  name = each.value.name
  host = each.value.host

  dynamic "port_list" {
    for_each = each.value.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
    }
  }
}

# Dynamically create service groups and associate servers
resource "thunder_slb_service_group" "service_group" {
  for_each = {for sg in local.config.servicegroup : sg.name => sg}

  name     = each.value.name
  protocol = each.value.protocol

  dynamic "member_list" {
    for_each = each.value.member_list
    content {
      # Ensure the server name matches a key in the thunder_slb_server.server map
      name = thunder_slb_server.server[member_list.value].name
      # Correctly reference the port number for the server
      port = thunder_slb_server.server[member_list.value].port_list[0].port_number
    }
  }
}

# Virtual Server
# VIP configuration with corrected syntax based on the documentation
resource "thunder_slb_virtual_server" "virtual_server" {
  name       = local.config.vip.name
  ip_address = local.config.vip.ip_address

#source_nat_auto = true
#enable_source_nat = true
  dynamic "port_list" {
    for_each = local.config.vip.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
      service_group = thunder_slb_service_group.service_group[port_list.value.service_group].name
     auto = 1

resource "thunder_file_aflex_local" "aflex_script" {
  action      = "import"
  dst_file    = "my_aflex_script"
  file        = "my_aflex_script"
  file_handle = "/opt/terraform/project_A10Terraform-v1/script.aflex"
  skip_backup = 0
}

#      template_persist_source_ip = try(port_list.value.template_persist_source_ip, null)
#      template_persist_cookie = try(port_list.value.template_persist_cookie, null)
}
}
}
                        

----
resource "thunder_virtual_server" "vip" {
  name       = "your_vip_name"
  ip_address = "your_vip_ip_address"
  
  // Other configuration for the VIP...
  
  aflex_script = thunder_file_aflex.aflex_script.dst_file
}

]]]]]]]]]


sh-3.2# vi main.tf

locals {
  config = yamldecode(file("${var.config_path}"))
}

# Dynamically create servers based on the config.yaml
resource "thunder_slb_server" "server" {
  for_each = {for s in local.config.servers : s.name => s}

  name = each.value.name
  host = each.value.host

  dynamic "port_list" {
    for_each = each.value.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
    }
  }
}

# Dynamically create service groups and associate servers
resource "thunder_slb_service_group" "service_group" {
  for_each = {for sg in local.config.servicegroup : sg.name => sg}

  name     = each.value.name
  protocol = each.value.protocol

  dynamic "member_list" {
    for_each = each.value.member_list
    content {
      # Ensure the server name matches a key in the thunder_slb_server.server map
      name = thunder_slb_server.server[member_list.value].name
      # Correctly reference the port number for the server
      port = thunder_slb_server.server[member_list.value].port_list[0].port_number
    }
  }
}

# Virtual Server
# VIP configuration with corrected syntax based on the documentation
resource "thunder_slb_virtual_server" "virtual_server" {
  name       = local.config.vip.name
  ip_address = local.config.vip.ip_address
#aflex_script = "my_aflex_script"
#source_nat_auto = true
#enable_source_nat = true
  dynamic "port_list" {
    for_each = local.config.vip.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
      service_group = thunder_slb_service_group.service_group[port_list.value.service_group].name
     auto = 1

#      template_persist_source_ip = try(port_list.value.template_persist_source_ip, null)
#      template_persist_cookie = try(port_list.value.template_persist_cookie, null)
}
}
}

resource "thunder_file_aflex_local" "aflex_script" {
  action      = "import"
  dst_file    = "my_aflex_scripts"
  file        = "my_aflex_scripts"
  file_handle = "/opt/terraform/project_A10Terraform-v1/script.aflex"
  skip_backup = 0
}

_____

sh-3.2# vi main.tf

locals {
  config = yamldecode(file("${var.config_path}"))
}

# Dynamically create servers based on the config.yaml
resource "thunder_slb_server" "server" {
  for_each = {for s in local.config.servers : s.name => s}

  name = each.value.name
  host = each.value.host

  dynamic "port_list" {
    for_each = each.value.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
    }
  }
}

# Dynamically create service groups and associate servers
resource "thunder_slb_service_group" "service_group" {
  for_each = {for sg in local.config.servicegroup : sg.name => sg}

  name     = each.value.name
  protocol = each.value.protocol

  dynamic "member_list" {
    for_each = each.value.member_list
    content {
      # Ensure the server name matches a key in the thunder_slb_server.server map
      name = thunder_slb_server.server[member_list.value].name
      # Correctly reference the port number for the server
      port = thunder_slb_server.server[member_list.value].port_list[0].port_number
    }
  }
}

# Virtual Server
# VIP configuration with corrected syntax based on the documentation
resource "thunder_slb_virtual_server" "virtual_server" {
  name       = local.config.vip.name
  ip_address = local.config.vip.ip_address
#aflex_script = "my_aflex_script"
#source_nat_auto = true
#enable_source_nat = true
  dynamic "port_list" {
    for_each = local.config.vip.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
      service_group = thunder_slb_service_group.service_group[port_list.value.service_group].name
     auto = 1

#      template_persist_source_ip = try(port_list.value.template_persist_source_ip, null)
#      template_persist_cookie = try(port_list.value.template_persist_cookie, null)
}
}
}

resource "thunder_file_aflex_local" "aflex_script" {
  action      = "import"
  dst_file    = "my_aflex_scripts"
  file        = "my_aflex_scripts"
  file_handle = "/opt/terraform/project_A10Terraform-v1/script.aflex"
  skip_backup = 0
}


====


sh-3.2# vi config.yaml 

load_balancer:
  ip_address: "10.228.34.212"
  partition: "a10tflab"

servers:
  real_server_1:
    name: "0990t05103hc01"
    host: "10.230.72.133"
    port_list:
      - port_number: 80
        protocol: "tcp"
      - port_number: 443
        protocol: "tcp"
  real_server_2:
    name: "0990t05103hc02"
    host: "10.230.72.139"
    port_list:
      - port_number: 80
        protocol: "tcp"
      - port_number: 443
        protocol: "tcp"

servicegroup:
  service_group_1:
    name: "a10tflab_nordstrom_net_service_group1"
    protocol: "tcp"
    port_number: 80
    lb_method: null
    health_check: test-health-monitor
    member_list:
      - "0990t05103hc01"

  service_group_2:
    name: "a10tflab_nordstrom_net_service_group2"
    protocol: "tcp"
    port_number: 443
    lb_method: "round-robin"
    health_check: null
    member_list:
      - "0990t05103hc02"


vip:
  name: "10tflab_nordstrom_net_virtual_server_1"
  ip_address: "10.230.72.159"
  port_list:
    - port_number: 80
      protocol: "http"
      service_group: "a10tflab_nordstrom_net_service_group1"
      template_persist_source_ip: "tflab-persistence-template"
      template_persist_cookie: "tflab-cookie-template"
      aflex_scripts: ["Terraform_aflex_script"]

======

sh-3.2# terraform plan
╷
│ Error: Unsupported argument
│ 
│   on main.tf line 54, in resource "thunder_slb_virtual_server" "virtual_server":
│   54:      aflex_scripts = port_list.value.aflex_scripts
│ 
│ An argument named "aflex_scripts" is not expected here. Did you mean to define a block of type "aflex_scripts"?

_________

sh-3.2# vi main.tf

locals {
  config = yamldecode(file("${var.config_path}"))
}

# Dynamically create servers based on the config.yaml
resource "thunder_slb_server" "server" {
  for_each = {for s in local.config.servers : s.name => s}

  name = each.value.name
  host = each.value.host

  dynamic "port_list" {
    for_each = each.value.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
    }
  }
}

# Dynamically create service groups and associate servers
resource "thunder_slb_service_group" "service_group" {
  for_each = {for sg in local.config.servicegroup : sg.name => sg}

  name     = each.value.name
  protocol = each.value.protocol

  dynamic "member_list" {
    for_each = each.value.member_list
    content {
      # Ensure the server name matches a key in the thunder_slb_server.server map
      name = thunder_slb_server.server[member_list.value].name
      # Correctly reference the port number for the server
      port = thunder_slb_server.server[member_list.value].port_list[0].port_number
    }
  }
}

# Virtual Server
# VIP configuration with corrected syntax based on the documentation
resource "thunder_slb_virtual_server" "virtual_server" {
  name       = local.config.vip.name
  ip_address = local.config.vip.ip_address

#source_nat_auto = true
#enable_source_nat = true
  dynamic "port_list" {
    for_each = local.config.vip.port_list
    content {
      port_number = port_list.value.port_number
      protocol    = port_list.value.protocol
      service_group = thunder_slb_service_group.service_group[port_list.value.service_group].name
     auto = 1
     aflex_scripts = port_list.value.aflex_scripts
#      template_persist_source_ip = try(port_list.value.template_persist_source_ip, null)
#      template_persist_cookie = try(port_list.value.template_persist_cookie, null)
}
}
}

resource "thunder_file_aflex_local" "aflex_script" {
  action      = "import"
  dst_file    = "my_aflex_scripts"
  file        = "my_aflex_scripts"
  file_handle = "/opt/terraform/project_A10Terraform-v1/script.aflex"
  skip_backup = 0
}
-----
dynamic "aflex" {
        for_each = port_list.value.aflex_scripts
        content {
          name = aflex.value
        }
      }
